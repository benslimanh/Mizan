<!doctype html>
<html lang="en" class="h-full">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Platform · Mizan Software</title>

    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />

    <link rel="stylesheet" href="./styles.css" />

    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              "brand-orange": "#f97316",
              charcoal: "#1e293b",
            },
            fontFamily: {
              sans: ["Inter", "ui-sans-serif", "system-ui", "sans-serif"],
            },
            boxShadow: {
              soft: "0 12px 32px rgba(15, 23, 42, 0.08)",
            },
          },
        },
      };
    </script>

    <!-- Insert Firebase SDKs (compat) before the guard script if not already present -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    
    <!-- Auth Guard: runs immediately and enforces strict access -->
    <script type="module">
      // Initialize Firebase if needed (same config as index.html)
      const firebaseConfig = {
        apiKey: "AIzaSyCBfjUajnfrFpZaaSfYx8JAyHLs2duFMw0",
        authDomain: "mizan-auth.firebaseapp.com",
        projectId: "mizan-auth",
        storageBucket: "mizan-auth.firebasestorage.app",
        messagingSenderId: "863003198174",
        appId: "1:863003198174:web:b7215ce349318b1b03b84f",
        measurementId: "G-R5L91BGKFC"
      };
    
      if (window.firebase && (!firebase.apps || !firebase.apps.length)) {
        firebase.initializeApp(firebaseConfig);
      }
    
      const redirectHome = () => window.location.replace("./index.html");
    
      const getEmailInitial = (email) => {
        const v = (email ?? "").trim();
        return v ? v[0].toUpperCase() : "U";
      };
    
      const formatMemberSince = (creationTime) => {
        const date = new Date(creationTime);
        return Number.isNaN(date.getTime())
          ? ""
          : date.toLocaleDateString(undefined, { year: "numeric", month: "short", day: "numeric" });
      };
    
      const setVerifiedUI = (user) => {
        const authButton = document.getElementById("authButton");
        const authEmail = document.getElementById("authEmail");
        const authNotice = document.getElementById("authNotice");
        const profileMenu = document.getElementById("profileMenu");
        const profileButton = document.getElementById("profileButton");
        const profileDropdown = document.getElementById("profileDropdown");
        const profileEmail = document.getElementById("profileEmail");
        const profileSince = document.getElementById("profileSince");
        const resendVerification = document.getElementById("resendVerification");
        const logoutButton = document.getElementById("logoutButton");
    
        // Hide auth prompts
        if (authButton) authButton.classList.add("hidden");
        if (authEmail) {
          authEmail.textContent = "";
          authEmail.classList.add("hidden");
        }
        if (authNotice) {
          authNotice.textContent = "";
          authNotice.classList.add("hidden");
        }
    
        // Show profile
        if (profileMenu) profileMenu.classList.remove("hidden");
        if (profileButton) profileButton.textContent = getEmailInitial(user?.email);
        if (profileEmail) profileEmail.textContent = user?.email ?? "";
        if (profileSince) {
          const since = formatMemberSince(user?.metadata?.creationTime);
          profileSince.textContent = since ? `Member since: ${since}` : "";
        }
        if (resendVerification) resendVerification.classList.add("hidden");
    
        // Dropdown toggle
        if (profileButton && profileDropdown) {
          profileButton.addEventListener("click", () => {
            profileDropdown.classList.toggle("hidden");
            if (window.lucide) window.lucide.createIcons();
          });
          window.addEventListener("click", (event) => {
            const pm = document.getElementById("profileMenu");
            const pd = document.getElementById("profileDropdown");
            if (!pm || pm.classList.contains("hidden")) return;
            if (!pm.contains(event.target)) pd?.classList.add("hidden");
          });
          window.addEventListener("keydown", (event) => {
            if (event.key === "Escape") document.getElementById("profileDropdown")?.classList.add("hidden");
          });
        }
    
        // Logout
        if (logoutButton) {
          logoutButton.addEventListener("click", async () => {
            try {
              await firebase.auth().signOut();
              redirectHome();
            } catch (e) {
              if (authNotice) {
                authNotice.textContent = e?.message ?? "Unable to sign out.";
                authNotice.classList.remove("hidden");
              }
            }
          });
        }
      };
    
      // Strict Auth Guard
      const enforceAccess = () => {
        if (!window.firebase || !firebase.auth) {
          redirectHome();
          return;
        }
        firebase.auth().onAuthStateChanged(async (user) => {
          if (!user) {
            redirectHome();
            return;
          }
          try {
            await user.reload?.();
          } catch (_) {}
          const currentUser = firebase.auth().currentUser ?? user;
          if (!currentUser?.emailVerified) {
            alert("Access Denied: Please verify your email first.");
            redirectHome();
            return;
          }
          setVerifiedUI(currentUser);
        });
      };
    
      enforceAccess();
    </script>
  </head>

  <body class="h-full bg-slate-50 font-sans text-slate-500 antialiased">
    <div class="min-h-screen">
      <aside class="fixed inset-y-0 left-0 w-[250px] bg-slate-900 text-white">
        <div id="sidebarLogo" class="flex items-center gap-2 px-4 py-4 border-b border-slate-800 cursor-pointer">
          <img src="logo.ico" alt="Mizan Logo" class="h-8" />
          <span class="text-sm font-semibold tracking-wide">Mizan Software</span>
        </div>
        <nav class="px-4 py-4 space-y-1">
          <a href="#" id="link-dashboard" data-view="dashboard" class="block rounded-lg px-3 py-2 text-sm hover:bg-slate-800">Dashboard</a>
          <a href="#" id="link-wallet" data-view="wallet" class="block rounded-lg px-3 py-2 text-sm hover:bg-slate-800">My Wallet</a>
          <a href="#" id="link-sukuk" data-view="sukuk" class="block rounded-lg px-3 py-2 text-sm hover:bg-slate-800">Sukuk Market</a>
          <a href="#" id="link-contracts" data-view="contracts" class="block rounded-lg px-3 py-2 text-sm hover:bg-slate-800">Smart Contracts</a>
          <a href="#" id="link-zakat" data-view="zakat" class="block rounded-lg px-3 py-2 text-sm hover:bg-slate-800">Zakat</a>
          <a href="#" id="link-settings" data-view="settings" class="block rounded-lg px-3 py-2 text-sm hover:bg-slate-800">Settings</a>
        </nav>
      </aside>

      <div class="ml-[250px]">
        <header class="sticky top-0 z-50 bg-white border-b border-slate-200">
          <div class="flex items-center justify-end px-4 py-3">
            <button class="rounded-xl p-2 text-slate-500 hover:bg-slate-100" aria-label="Notifications">
              <i data-lucide="bell" class="h-5 w-5"></i>
            </button>
            <div id="profileMenu" class="relative ml-2">
              <button
                id="profileButton"
                class="grid h-10 w-10 place-items-center rounded-full bg-brand-orange text-sm font-bold text-white shadow-sm shadow-brand-orange/20"
              ></button>
              <div
                id="profileDropdown"
                class="absolute right-0 mt-3 hidden w-80 rounded-3xl border border-slate-200 bg-white/80 p-5 shadow-soft backdrop-blur-md"
              >
                <div class="text-xs font-semibold tracking-[0.22em] text-slate-400">PROFILE</div>
                <div id="profileEmail" class="mt-3 text-sm font-semibold text-charcoal"></div>
                <div id="profileSince" class="mt-1 text-xs font-semibold text-slate-500"></div>

                <div class="mt-5 flex flex-col gap-2">
                  <button
                    type="button"
                    id="logoutButton"
                    class="inline-flex items-center justify-center gap-2 rounded-xl border border-slate-200 bg-white px-4 py-3 text-sm font-semibold text-charcoal shadow-sm hover:bg-slate-50"
                  >
                    <i data-lucide="log-out" class="h-4 w-4 text-brand-orange"></i>
                    Logout
                  </button>
                </div>
              </div>
            </div>
          </div>
        </header>

        <div id="verificationBanner" class="hidden bg-orange-100 border-y border-orange-200">
          <div class="mx-auto max-w-6xl px-4 py-3 flex items-center justify-between">
            <div class="text-sm font-semibold text-charcoal">Your email is not verified.</div>
            <button
              type="button"
              id="resendVerification"
              class="inline-flex items-center justify-center gap-2 rounded-xl border border-orange-300 bg-white px-4 py-2 text-sm font-semibold text-charcoal shadow-sm hover:bg-orange-50"
            >
              <i data-lucide="mail" class="h-4 w-4 text-brand-orange"></i>
              Resend Link
            </button>
          </div>
        </div>

        <main class="px-4 py-6">
          <section id="view-dashboard">
            <section class="mx-auto max-w-6xl">
              <h1 class="text-2xl font-bold text-charcoal">
                As-salamu alaykum, <span id="welcomeEmail" class="font-semibold"></span>
              </h1>
            </section>

            <section class="mx-auto max-w-6xl mt-6 grid grid-cols-1 gap-6 md:grid-cols-3">
              <div class="rounded-2xl border border-slate-200 bg-white p-6 shadow-sm">
                <div class="text-sm font-semibold text-slate-500">Balance</div>
                <div class="mt-2 text-2xl font-bold text-charcoal">$25,400</div>
              </div>
              <div class="rounded-2xl border border-slate-200 bg-white p-6 shadow-sm">
                <div class="text-sm font-semibold text-slate-500">Active Contracts</div>
                <div class="mt-2 text-2xl font-bold text-charcoal">12</div>
              </div>
              <div class="rounded-2xl border border-slate-200 bg-white p-6 shadow-sm">
                <div class="text-sm font-semibold text-slate-500">Zakat</div>
                <div class="mt-2 text-2xl font-bold text-charcoal">$1,250</div>
              </div>
            </section>

            <section class="mx-auto max-w-6xl mt-6 rounded-2xl border border-slate-200 bg-white p-6 shadow-sm">
              <div class="flex items-center justify-between">
                <div class="text-base font-semibold text-charcoal">Transactions</div>
                <div class="text-xs font-medium text-slate-500">Blockchain History</div>
              </div>
              <div class="mt-4 overflow-x-auto">
                <table class="min-w-full text-sm">
                  <thead>
                    <tr class="text-left text-slate-500">
                      <th class="py-2 pr-4">Hash</th>
                      <th class="py-2 pr-4">Type</th>
                      <th class="py-2 pr-4">Asset</th>
                      <th class="py-2 pr-4">Amount</th>
                      <th class="py-2 pr-4">Status</th>
                      <th class="py-2 pr-4">Date</th>
                    </tr>
                  </thead>
                  <tbody class="text-charcoal">
                    <tr class="border-t border-slate-200">
                      <td class="py-2 pr-4 font-mono text-xs">0x9f...ab12</td>
                      <td class="py-2 pr-4">Murabaha</td>
                      <td class="py-2 pr-4">Equipment</td>
                      <td class="py-2 pr-4">$3,000</td>
                      <td class="py-2 pr-4 text-emerald-600 font-semibold">Confirmed</td>
                      <td class="py-2 pr-4">2026-01-01</td>
                    </tr>
                    <tr class="border-t border-slate-200">
                      <td class="py-2 pr-4 font-mono text-xs">0x3c...74e9</td>
                      <td class="py-2 pr-4">Sukuk</td>
                      <td class="py-2 pr-4">Bond A</td>
                      <td class="py-2 pr-4">$12,000</td>
                      <td class="py-2 pr-4 text-amber-600 font-semibold">Pending</td>
                      <td class="py-2 pr-4">2026-01-03</td>
                    </tr>
                    <tr class="border-t border-slate-200">
                      <td class="py-2 pr-4 font-mono text-xs">0x7a...0df1</td>
                      <td class="py-2 pr-4">Zakat</td>
                      <td class="py-2 pr-4">Donation</td>
                      <td class="py-2 pr-4">$250</td>
                      <td class="py-2 pr-4 text-emerald-600 font-semibold">Confirmed</td>
                      <td class="py-2 pr-4">2026-01-04</td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </section>
          </section>

          <section id="view-wallet" class="hidden">
            <section class="mx-auto max-w-6xl">
              <h1 class="text-2xl font-bold text-charcoal">My Digital Wallet</h1>
            </section>

            <section class="mx-auto max-w-6xl mt-6 grid grid-cols-1 gap-6 md:grid-cols-3">
              <div class="md:col-span-2 rounded-2xl border border-slate-200 bg-white p-6 shadow-sm">
                <div class="flex items-center justify-between">
                  <div>
                    <div class="text-sm font-semibold text-slate-500">Total Balance</div>
                    <div class="mt-2 text-3xl font-bold text-charcoal">$12,450.00</div>
                  </div>
                  <div class="flex gap-2">
                    <button class="inline-flex items-center gap-2 rounded-xl bg-emerald-600 px-4 py-2 text-sm font-semibold text-white shadow-sm hover:bg-emerald-700">
                      <i data-lucide="download" class="h-4 w-4"></i>
                      Deposit
                    </button>
                    <button class="inline-flex items-center gap-2 rounded-xl border border-orange-300 bg-white px-4 py-2 text-sm font-semibold text-orange-600 hover:bg-orange-50">
                      <i data-lucide="upload" class="h-4 w-4 text-orange-600"></i>
                      Withdraw
                    </button>
                  </div>
                </div>
              </div>
              <div class="rounded-2xl border border-slate-200 bg-white p-6 shadow-sm">
                <div class="text-sm font-semibold text-charcoal">Asset Breakdown</div>
                <div class="mt-3 space-y-2">
                  <div class="flex items-center justify-between"><span class="text-slate-600">Cash</span><span class="font-semibold text-charcoal">40%</span></div>
                  <div class="flex items-center justify-between"><span class="text-slate-600">Sukuk</span><span class="font-semibold text-charcoal">60%</span></div>
                </div>
                <div class="mt-4 h-32 rounded-xl bg-slate-100 grid place-items-center text-xs text-slate-500">Pie Chart Placeholder</div>
              </div>
            </section>

            <section class="mx-auto max-w-6xl mt-6 rounded-2xl border border-slate-200 bg-white p-6 shadow-sm">
              <div class="text-base font-semibold text-charcoal">Wallet History</div>
              <ul class="mt-4 divide-y divide-slate-200 text-sm">
                <li class="py-2 flex items-center justify-between">
                  <span class="text-slate-600">Deposit</span>
                  <span class="font-semibold text-emerald-600">+$500.00</span>
                  <span class="text-xs text-slate-500">2026-01-02</span>
                </li>
                <li class="py-2 flex items-center justify-between">
                  <span class="text-slate-600">Withdraw</span>
                  <span class="font-semibold text-orange-600">-$250.00</span>
                  <span class="text-xs text-slate-500">2026-01-03</span>
                </li>
                <li class="py-2 flex items-center justify-between">
                  <span class="text-slate-600">Deposit</span>
                  <span class="font-semibold text-emerald-600">+$1,200.00</span>
                  <span class="text-xs text-slate-500">2026-01-05</span>
                </li>
              </ul>
            </section>
          </section>

          <section id="view-sukuk" class="hidden">
            <section class="mx-auto max-w-6xl grid place-items-center py-16">
              <div class="text-center">
                <i data-lucide="layers" class="mx-auto h-14 w-14 text-slate-400"></i>
                <h1 class="mt-4 text-2xl font-bold text-charcoal">Sukuk Market</h1>
                <p class="mt-2 text-sm text-slate-500">Coming soon: market listings and analytics.</p>
              </div>
            </section>
          </section>

          <section id="view-contracts" class="hidden">
            <section class="mx-auto max-w-6xl grid place-items-center py-16">
              <div class="text-center">
                <i data-lucide="file-code" class="mx-auto h-14 w-14 text-slate-400"></i>
                <h1 class="mt-4 text-2xl font-bold text-charcoal">Coming Soon: Automated Smart Contracts</h1>
              </div>
            </section>
          </section>

          <section id="view-zakat" class="hidden">
            <section class="mx-auto max-w-6xl grid place-items-center py-16">
              <div class="text-center">
                <i data-lucide="calculator" class="mx-auto h-14 w-14 text-slate-400"></i>
                <h1 class="mt-4 text-2xl font-bold text-charcoal">Zakat Calculator & Audit</h1>
                <p class="mt-2 text-sm text-slate-500">Coming soon: calculation tools and distribution ledger.</p>
              </div>
            </section>
          </section>

          <section id="view-settings" class="hidden">
            <section class="mx-auto max-w-6xl">
              <h1 class="text-2xl font-bold text-charcoal">Account Settings</h1>
            </section>

            <section class="mx-auto max-w-6xl mt-6 grid grid-cols-1 gap-6 md:grid-cols-2">
              <div class="rounded-2xl border border-slate-200 bg-white p-6 shadow-sm">
                <div class="text-base font-semibold text-charcoal">Profile</div>
                <div class="mt-4 space-y-4">
                  <div>
                    <label class="text-sm font-semibold text-charcoal" for="settingsName">Full Name</label>
                    <input id="settingsName" type="text" class="mt-2 w-full rounded-xl border border-slate-200 bg-white px-4 py-3 text-sm text-charcoal shadow-sm placeholder:text-slate-400 focus:border-brand-orange focus:outline-none focus:ring-4 focus:ring-brand-orange/15" placeholder="Your Name" />
                  </div>
                  <div>
                    <label class="text-sm font-semibold text-charcoal" for="settingsEmail">Email</label>
                    <input id="settingsEmail" type="email" readonly class="mt-2 w-full rounded-xl border border-slate-200 bg-slate-50 px-4 py-3 text-sm text-charcoal shadow-sm" />
                  </div>
                </div>
              </div>

              <div class="rounded-2xl border border-slate-200 bg-white p-6 shadow-sm">
                <div class="text-base font-semibold text-charcoal">Security</div>
                <div class="mt-4 space-y-4">
                  <div>
                    <label class="text-sm font-semibold text-charcoal" for="settingsCurrentPassword">Current Password</label>
                    <input id="settingsCurrentPassword" type="password" class="mt-2 w-full rounded-xl border border-slate-200 bg-white px-4 py-3 text-sm text-charcoal shadow-sm placeholder:text-slate-400 focus:border-brand-orange focus:outline-none focus:ring-4 focus:ring-brand-orange/15" placeholder="••••••••" />
                  </div>
                  <div>
                    <label class="text-sm font-semibold text-charcoal" for="settingsNewPassword">New Password</label>
                    <input id="settingsNewPassword" type="password" class="mt-2 w-full rounded-xl border border-slate-200 bg-white px-4 py-3 text-sm text-charcoal shadow-sm placeholder:text-slate-400 focus:border-brand-orange focus:outline-none focus:ring-4 focus:ring-brand-orange/15" placeholder="••••••••" />
                  </div>
                  <div>
                    <button id="settingsUpdatePassword" class="inline-flex items-center justify-center gap-2 rounded-xl bg-brand-orange px-4 py-3 text-sm font-semibold text-white shadow-sm shadow-brand-orange/20 hover:bg-brand-orange/95">
                      <i data-lucide="key-round" class="h-4 w-4"></i>
                      Update Password
                    </button>
                  </div>
                </div>
              </div>
            </section>

            <section class="mx-auto max-w-6xl mt-6 rounded-2xl border border-slate-200 bg-white p-6 shadow-sm">
              <div class="text-base font-semibold text-charcoal">Preferences</div>
              <div class="mt-4">
                <label class="inline-flex items-center cursor-pointer">
                  <input type="checkbox" id="prefEmails" class="sr-only peer" />
                  <div class="relative h-6 w-10 rounded-full bg-slate-300 transition peer-checked:bg-emerald-600">
                    <span class="absolute left-1 top-1 h-4 w-4 rounded-full bg-white transition peer-checked:translate-x-4"></span>
                  </div>
                  <span class="ml-3 text-sm text-charcoal">Email Notifications</span>
                </label>
              </div>
            </section>
          </section>
        </main>
      </div>
    </div>

    <script src="https://unpkg.com/lucide@latest"></script>
    <script>
      window.addEventListener("load", () => {
        if (window.lucide) window.lucide.createIcons();
        const welcomeEmail = document.getElementById("welcomeEmail");
        const verificationBanner = document.getElementById("verificationBanner");
        const resendVerification = document.getElementById("resendVerification");
        const views = {
          dashboard: document.getElementById("view-dashboard"),
          wallet: document.getElementById("view-wallet"),
          sukuk: document.getElementById("view-sukuk"),
          zakat: document.getElementById("view-zakat"),
          contracts: document.getElementById("view-contracts"),
          settings: document.getElementById("view-settings"),
        };
        const sidebarLinks = Array.from(document.querySelectorAll("aside nav a[data-view]"));

        const setActiveView = (name) => {
          Object.entries(views).forEach(([key, el]) => {
            if (!el) return;
            if (key === name) el.classList.remove("hidden");
            else el.classList.add("hidden");
          });
          sidebarLinks.forEach((link) => {
            const isActive = link.dataset.view === name;
            link.classList.toggle("bg-slate-800", isActive);
            link.classList.toggle("text-white", isActive);
          });
        };

        sidebarLinks.forEach((link) => {
          link.addEventListener("click", (e) => {
            e.preventDefault();
            const name = link.dataset.view;
            if (!name) return;
            setActiveView(name);
            try {
              history.replaceState(null, "", `#${name}`);
            } catch (_) {}
          });
        });

        const sidebarLogo = document.getElementById("sidebarLogo");
        if (sidebarLogo) {
          sidebarLogo.addEventListener("click", () => {
            setActiveView("dashboard");
            try {
              history.replaceState(null, "", `#dashboard`);
            } catch (_) {}
          });
        }

        const initialHash = (window.location.hash || "").replace("#", "");
        if (initialHash && views[initialHash]) setActiveView(initialHash);
        else setActiveView("dashboard");

        if (window.firebase && firebase.auth) {
          firebase.auth().onAuthStateChanged((user) => {
            if (welcomeEmail) welcomeEmail.textContent = user?.email ?? "";
            if (user && !user.emailVerified) {
              verificationBanner?.classList.remove("hidden");
              if (resendVerification) {
                resendVerification.addEventListener("click", async () => {
                  try {
                    const currentUser = firebase.auth().currentUser ?? user;
                    await currentUser.sendEmailVerification();
                  } catch (_) {}
                });
              }
            } else {
              verificationBanner?.classList.add("hidden");
            }
          });
        }
      });
    </script>
  </body>
</html>
